#!/bin/bash

# Default values
AFTER=""
BEFORE=""
FILTER=""
COMMAND="list"
USERNAME=""
LOGS=""
CURRENCIES=()

# Parse options
echo "Initial FILTER: $FILTER"
while [[ $# -gt 0 ]]; do
    case "$1" in
        -h | --help )
            echo "Usage: xtf [-h|--help] [FILTR] [PŘÍKAZ] UŽIVATEL LOG [LOG2 [...]]"
            echo "Options:"
            echo "  -h, --help          Display this help message"
            echo "  -a, --after DATETIME         Filter records after DATETIME"
            echo "  -b, --before DATETIME         Filter records before DATETIME"
            echo "  -c, --currency CURRENCY         Filter records by currency"
            exit 0
        ;;
        -a | --after )
            AFTER+="$2"
            shift 2
        ;;
        -b | --before )
            BEFORE+="$2"
            shift 2
        ;;
        -c | --currency )
            CURRENCIES+=("$2")
            shift 2
        ;;
        -*)
            echo "Error: Unknown option: $1" >&2
            exit 1
        ;;
        *)
            break
        ;;
    esac
done
FILTER="$AFTER $BEFORE"

# Extracting the rest of the arguments
if [ $# -ge 3 ]; then
    COMMAND=$1
    USERNAME=$2
    shift 2
    LOGS="$@"
    elif [ $# -eq 2 ]; then
    USERNAME=$1
    shift
    LOGS="$1"
    elif [ $# -eq 1 ]; then
    USERNAME=$1
else
    echo "Error: Insufficient arguments." >&2
    exit 1
fi

# Výpis informací
echo "Filter: $FILTER"
echo "Command: $COMMAND"
echo "Username: $USERNAME"
echo "Logs: $LOGS"
echo "Currencies: ${CURRENCIES[@]}"

# Ověření, zda je COMMAND platný
case "$COMMAND" in
    list | list-currency | status | profit)
        echo "Command is valid: $COMMAND"
    ;;
    *)
        echo "Error: Invalid command: $COMMAND" >&2
        exit 1
    ;;
esac


# Pokud je zadaný filtr -a, vypíše se získané datum a čas
if [ -n "$AFTER" ]; then
    echo "Filtr -a byl zadán s hodnotou: $AFTER"
else
    echo "Filtr -a nebyl zadán."
fi


# Pokud je zadaný filtr -b, vypíše se získané datum a čas
if [ -n "$BEFORE" ]; then
    echo "Filtr -b byl zadán s hodnotou: $BEFORE"
else
    echo "Filtr -b nebyl zadán."
fi

# Získání data a času ze zadaného filtru
CURRENCY=$(echo "$FILTER" | grep -oP '\s-c\s\K[^\s]+')

# Pokud je zadaný filtr -a, vypíše se získané datum a čas
if [ -n "$CURRENCIES" ]; then
    echo "Filtr -c byl zadán s hodnotou: ${CURRENCIES[@]}"
else
    echo "Filtr -c nebyl zadán."
fi

case "$COMMAND" in
    list | list-currency | status | profit)
        case "$COMMAND" in
            list | list-currency)
                awk -F';' -v bfr="$BEFORE" -v afr="$AFTER" -v cur=$CURRENCY -v com=$COMMAND -v user=$USERNAME \
                'function convdate(date){
                    if (date ~ /^[0-9]{4}-[0-9]{2}-[0-9]{2}$/) {
                        gsub(/[-]/, "", date);
                        date = date "000000";  # Přidej výchozí čas (půlnoc)
                    }
                    # Pokud je formát YYYY-MM-DD HH:MM::SS
                    else if (date ~ /^[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}$/) {
                        gsub(/[-: ]/, "", date);
                    }
                    return date;
                }
                {if(user==$1 && (!bfr || convdate(bfr) < convdate($2)) && (!afr || convdate(afr) > convdate($2)))
                        if(com=="list-currency") print $3
                       else if(cur==$3 || !cur) print}' log.txt | uniq
            ;;
            *)
            ;;
        esac
        echo "Command is valid."
    ;;
    *)
        echo "Error: Invalid command." >&2
        exit 1
    ;;
esac


# awk -F';' '{print $1}' log.txt